using Estimator.Services;
using MathNet.Numerics.LinearAlgebra;
using System.Text.Json;

namespace Tests
{
  public class CointegrationTests
  {
    [Fact]
    public void Calculate()
    {
      var data = Matrix<double>.Build.DenseOfArray(new double[,]
      {
        {100.00, 50.00, 73.50},
        {101.24, 49.83, 74.12},
        {102.17, 50.65, 75.38},
        {101.89, 51.42, 74.97},
        {103.42, 50.91, 76.28},
        {104.76, 51.78, 77.15},
        {105.33, 52.41, 77.82},
        {106.91, 51.97, 78.63},
        {107.48, 52.84, 79.50},
        {108.62, 53.27, 80.44},
        {109.35, 54.13, 81.31},
        {108.97, 53.69, 80.92},
        {110.43, 54.82, 81.88},
        {111.76, 55.39, 83.04},
        {112.91, 56.27, 84.22},
        {113.48, 55.83, 84.79},
        {114.62, 56.71, 85.67},
        {115.79, 57.34, 86.84},
        {116.43, 58.22, 87.52},
        {117.68, 57.78, 88.17},
        {118.91, 58.66, 89.40},
        {119.53, 59.29, 90.12},
        {120.87, 60.17, 91.26},
        {121.42, 59.73, 91.81},
        {122.65, 60.61, 92.94},
        {123.91, 61.24, 94.20},
        {124.53, 62.12, 94.82},
        {125.78, 61.68, 95.57},
        {127.01, 62.56, 96.70},
        {128.27, 63.19, 97.96},
        {129.43, 64.07, 99.02},
        {128.98, 63.63, 98.57},
        {130.21, 64.51, 99.70},
        {131.47, 65.14, 100.96},
        {132.63, 66.02, 102.02},
        {133.88, 65.58, 102.77},
        {135.01, 66.46, 103.80},
        {136.27, 67.09, 105.06},
        {137.43, 67.97, 106.12},
        {136.98, 67.53, 105.67},
        {138.21, 68.41, 106.80},
        {139.47, 69.04, 108.06},
        {140.63, 69.92, 109.12},
        {141.88, 69.48, 109.87},
        {143.01, 70.36, 110.90},
        {144.27, 70.99, 112.16},
        {145.43, 71.87, 113.22},
        {144.98, 71.43, 112.77},
        {146.21, 72.31, 113.90},
        {147.47, 72.94, 115.16},
        {148.63, 73.82, 116.22},
        {149.88, 73.38, 116.97},
        {151.01, 74.26, 118.00},
        {152.27, 74.89, 119.26},
        {153.43, 75.77, 120.32},
        {152.98, 75.33, 119.87},
        {154.21, 76.21, 121.00},
        {155.47, 76.84, 122.26},
        {156.63, 77.72, 123.32},
        {157.88, 77.28, 124.07},
        {159.01, 78.16, 125.10},
        {160.27, 78.79, 126.36},
        {161.43, 79.67, 127.42},
        {160.98, 79.23, 126.97},
        {162.21, 80.11, 128.10},
        {163.47, 80.74, 129.36},
        {164.63, 81.62, 130.42},
        {165.88, 81.18, 131.17},
        {167.01, 82.06, 132.20},
        {168.27, 82.69, 133.46},
        {169.43, 83.57, 134.52},
        {168.98, 83.13, 134.07},
        {170.21, 84.01, 135.20},
        {171.47, 84.64, 136.46},
        {172.63, 85.52, 137.52},
        {173.88, 85.08, 138.27},
        {175.01, 85.96, 139.30},
        {176.27, 86.59, 140.56},
        {177.43, 87.47, 141.62},
        {176.98, 87.03, 141.17},
        {178.21, 87.91, 142.30},
        {179.47, 88.54, 143.56},
        {180.63, 89.42, 144.62},
        {181.88, 88.98, 145.37},
        {183.01, 89.86, 146.40},
        {184.27, 90.49, 147.66},
        {185.43, 91.37, 148.72},
        {184.98, 90.93, 148.27},
        {186.21, 91.81, 149.40},
        {187.47, 92.44, 150.66},
        {188.63, 93.32, 151.72},
        {189.88, 92.88, 152.47},
        {191.01, 93.76, 153.50},
        {192.27, 94.39, 154.76},
        {193.43, 95.27, 155.82},
        {192.98, 94.83, 155.37},
        {194.21, 95.71, 156.50},
        {195.47, 96.34, 157.76},
        {196.63, 97.22, 158.82},
        {197.88, 96.78, 159.57},
        {199.01, 97.66, 160.60},
        {200.27, 98.29, 161.86},
        {201.43, 99.17, 162.92},
        {200.98, 98.73, 162.47},
        {202.21, 99.61, 163.60},
        {203.47, 100.24, 164.86},
        {204.63, 101.12, 165.92},
        {205.88, 100.68, 166.67},
        {207.01, 101.56, 167.70},
        {208.27, 102.19, 168.96},
        {209.43, 103.07, 170.02},
        {208.98, 102.63, 169.57},
        {210.21, 103.51, 170.70},
        {211.47, 104.14, 171.96},
        {212.63, 105.02, 173.02},
        {213.88, 104.58, 173.77},
        {215.01, 105.46, 174.80},
        {216.27, 106.09, 176.06},
        {217.43, 106.97, 177.12}
      });

      var response = JohansenCore.Run(data, 1, JohansenModel.Model0);
      var rank = JohansenModelSelector.SelectRank(response, SignificanceLevel.x95, data.ColumnCount);
      var beta = response.EigenVectors.SubMatrix(0, data.ColumnCount, 0, rank);
      var ratio = beta.Column(0);
      var standardRatio = ratio / ratio[0];
      var spread = data * standardRatio;
      var mean = spread.Average();
      var std = Math.Sqrt(spread.Average(x => (x - mean) * (x - mean)));

      Console.WriteLine("Response");
      Console.WriteLine(JsonSerializer.Serialize(response));

      Console.WriteLine("Beta");
      Console.WriteLine(JsonSerializer.Serialize(beta));

      Console.ReadLine();

      //Assert.Equal(2, result.Rank);
    }
  }
}